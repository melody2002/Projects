#!/usr/bin/bash

# WEB SERVER START
sudo apt update
sudo apt install apache2

sudo mkdir -p /srv/www/htdocs/site1.com
sudo mkdir -p /srv/www/htdocs/site2.com

sudo chown -R $USER /srv/www/htdocs/site1.com
sudo chown -R $USER /srv/www/htdocs/site2.com
sudo chmod -R 755 /srv/www/htdocs/site1.com
sudo chmod -R 755 /srv/www/htdocs/site2.com

# SITE 1
sudo nano /srv/www/htdocs/site1.com/index.html
<html>
   <head>
    <title> Welcome to Site1.com! </title>
   </head>
   <body>
        <h1> Success! The Site1.com Virtual host is working! </h1>
   </body>
</html>

# SITE 2
sudo nano /srv/www/htdocs/site2.com/index.html
<html>
   <head>
    <title> Welcome to Site2.com! </title>
   </head>
   <body>
        <h1> Success! The Site2.com Virtual host is working! </h1>
   </body>
</html>

# SITE 1
sudo nano /etc/apache2/sites-available/site1.com.conf
<VirtualHost *:80>
        ServerAdmin 22110670@imail.sunway.edu.my
        ServerName site1.com
        ServerAlias www.site1.com
        DocumentRoot /srv/www/htdocs/site1.com/ 
        ErrorLog ${APACHE_LOG_DIR}/error.log
        Customlog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

# SITE 2
sudo nano /etc/apache2/sites-available/site2.com.conf
<VirtualHost *:80>
        ServerAdmin 22110670@imail.sunway.edu.my
        ServerName site2.com
        ServerAlias www.site2.com
        DocumentRoot /srv/www/htdocs/site2.com/
        ErrorLog ${APACHE_LOG_DIR}/error.log
        Customlog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

# htpasswd File
sudo install apache2-utils
sudo htpasswd -c /etc/apache2/.htpasswd user1

sudo nano /etc/apache2/sites-available/site1.com.conf
# Site 1
<VirtualHost *:80>
        ServerAdmin 22110670@imail.sunway.edu.my
        ServerName site1.com
        ServerAlias www.site1.com
        DocumentRoot /srv/www/htdocs/site1.com/
        ErrorLog ${APACHE_LOG_DIR}/error.log
        Customlog ${APACHE_LOG_DIR}/access.log combined
 <Directory "/srv/www/htdocs/site1.com/">
        AuthType Basic
        AuthName "Restricted Access"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
 </Directory>
</VirtualHost>

sudo nano /etc/apache2/sites-available/site2.com.conf
# Site 2
<VirtualHost *:80>
        ServerAdmin 22110670@imail.sunway.edu.my
        ServerName site2.com
        ServerAlias www.site2.com
        DocumentRoot /srv/www/htdocs/site2.com/
        ErrorLog ${APACHE_LOG_DIR}/error.log
        Customlog ${APACHE_LOG_DIR}/access.log combined
 <Directory "/srv/www/htdocs/site2.com/">
        AuthType Basic
        AuthName "Restricted Access"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
 </Directory>
</VirtualHost>

sudo a2ensite site1.com.conf
sudo a2ensite site2.com.conf
sudo a2dissite 000-default.conf

sudo systemctl restart apache2
sudo systemctl status apache2

# Set Up Local Host File
sudo nano /etc/hosts
127.0.0.1 localhost
127.0.1.1 ubuntu
192.168.25.10 site1.com
192.168.25.10 site2.com
192.168.25.1 site1.com
192.168.25.1 site2.com
# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts

# Limit the number of connected clients to 2
sudo nano /etc/apache2/mods-available/mpm_event.conf

StartServers            2
MinSpareThreads         25
MaxSpareThreads         2
ThreadLimit             64
ThreadsPerChild         25
MaxRequestWorkers       2
MaxConnectionsPerChild  2


# Shell Script to Monitor Web Server
sudo nano web_server_monitor.sh

#!/bin/bash
INTERFACE=${1:wlp0s20f3}
echo "=============================="
echo "Monitoring Webserver Report"
echo "==============================" 
echo "Press ctrl+c to Stop"


while :
do

        # Monitor number of connected users
        conUsers=$(ss -ant | awk '$5 ~ /:80$/ && $1 == "ESTAB" {count++} END {print count}')

        # Monitor CPU and Memorey Usage
        cpuUsage=$(top -bn1 | grep load | awk '{printf "%.2f%%\t\t\n",$(NF-2)}')
        memUsage=$(free -m | awk 'NR==2{printf "%.2f%%\t\t",$3*100/$2}')

        # Print Usage
        echo "----------------------------------------"
        echo "Connetced Users: $conUsers"
        echo "CPU Usage: $cpuUsage"
        echo "Memory Usage: $memUsage"
        echo "----------------------------------------"

        # Sleep for 5 seconds
        sleep 5
done


sudo chmod +x web_server_monitor.sh

sudo ./web_server_monitor.sh

sudo systemctl enable apache2
sudo systemctl is-enabled apache2
sudo systemctl restart apache2
sudo systemctl status apache2

# WEB SERVER ENDS

# DNS SERVER START

sudo apt install -y bind9
sudo apt install -y dnsutils


# Configure Local Files
sudo nano /etc/bind/named.conf.local
# Forward Zone
zone "site1.com" {
        type master;
        file "/etc/bind/zones/db.site1.com"; # Zone file path for site1.com
};

zone "site2.com" {
        type master;
        file "/etc/bind/zones/db.site2.com"; # Zone file path for site2.com
};
# Reverse Zone
zone "25.168.192.in-addr.arpa" {
        type master;
        file "/etc/bind/zones/db.25.168.192"; # Zone file path for 192.168.25.0/24
};

sudo mkdir /etc/bind/zones

sudo nano /etc/bind/zones/db.site1.com                       
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA     ns1.site1.com. root.site1.com. (
                              1         ; Serial
                         604800         ; Refresh
                          86400     
                          ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
; A-AAAA record

@       IN      NS      ns1.site1.com.
@	IN	A	192.168.25.10
ns1     IN      A       192.168.25.10

; CNAME record
www	IN	CNAME	site1.com.
zzz	IN	CNAME	site1.com.

@	IN	A	127.0.0.1
@	IN	AAAA	::1

sudo nano /etc/bind/zones/db.site2.com  
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA     ns1.site2.com. root.site2.com. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
; A-AAAA record

@       IN      NS      ns1.site2.com.
@	IN	A	192.168.25.10
ns1     IN      A       192.168.25.10

; CNAME record
www	IN	CNAME	site2.com.
zzz	IN	CNAME	site2.com.

@	IN	A	127.0.0.1
@	IN	AAAA	::1


sudo nano /etc/bind/zones/db.25.168.192
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA     site1.com. root.site1.com. (
                              3         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
; 
@       IN      NS      ns1.site1.com.
10      IN      PTR     site1.com.   
10      IN      PTR     site2.com.   

                        
# CHECK CONFIGURATION
sudo named-checkzone 25.168.192.in-addr.arp /etc/bind/zones/db.25.168.192

sudo named-checkzone site1.com /etc/bind/zones/db.site1.com
sudo named-checkzone site2.com /etc/bind/zones/db.site2.com

sudo systemctl restart bind9
sudo systemctl status bind9

# DNS SERVER ENDS

# DHCP SERVER
sudo apt install kea

sudo nano /etc/kea/kea-dhcp4.conf

{
"Dhcp4": {
    // Add names of your network interfaces to listen on.
    "interfaces-config": {
        "interfaces": ["wlp0s20f3"]
    },


    // Global timers specified here apply to all subnets, unless there are
    // subnet specific values defined in particular subnets.
    "renew-timer": 18000,
    "rebind-timer": 28800,
    "valid-lifetime": 36000,


    "subnet4": [
        {
            "subnet": "192.168.25.1/24",

        //Pools define the actual part of your subnet that is governed bu kea

          "pools": [ { "pool": "192.168.25.100 - 192.168.25.200" } ],

      "option-data": [
                {
                    // For each IPv4 subnet you most likely need to specify at
                    // least one router.
                    "name": "routers",
                    "data": "192.168.25.1"
                },

                {
                        "name": "domain-name-servers",
                        "data": "192.168.25.10, 192.168.25.20"
                }
            ]
        }
     ]
}

}

systemctl restart kea-dhcp4-server
systemctl enable kea-dhcp4-server
systemctl status kea-dhcp4-server

# DHCP SERVER ENDS



# WIRELESS ACCESS POINT START
sudo apt update
sudo apt install network-manager
sudo apt install hostapd
sudo apt install wireless-tools iw

sudo nano /etc/hostapd/hostapd.conf
# Set Wireless Interface
interface= wlp0s20f3

# Wifi Channel
channel=11

# Network Parameters and Security
ssid=NetworkAdim_25
wpa=2
wpa_key_mgmt=WPA-PSK
wpa_passphrase=sunway12
rsn_pairwise=CCMP

# Mode for Access Point
hw_mode=g


sudo nano /etc/network/interfaces
# Network Interfaces
auto wlp0s20f3
iface wlp0s20f3 inet static
address 192.168.25.1
netmask 255.255.255.0

sudo nano /etc/sysctl.conf
net.ipv4.ip_forward=1

sudo iptables -t nat -A POSTROUTING -o wlp0s20f3 -j MASQUERADE


# WAP MONITOR SCRIPT                                                                     
sudo nano monitor_wap.sh
                                                                                 
#!/bin/bash

INTERFACE="wlp0s20f3"
INTERVAL=1

while true; do
RX_BYTES_OLD=$(cd /sys/class/net/$INTERFACE/statistics/ && cat rx_bytes)
TX_BYTES_OLD=$(cd /sys/class/net/$INTERFACE/statistics/ && cat tx_bytes)

        sleep $INTERVAL

        RX_BYTES_NEW=$(cd /sys/class/net/$INTERFACE/statistics/ && cat rx_bytes)
        TX_BYTES_NEW=$(cd /sys/class/net/$INTERFACE/statistics/ && cat tx_bytes)

        RX_DIFF=$(($RX_BYTES_NEW - $RX_BYTES_OLD))
        TX_DIFF=$(($TX_BYTES_NEW - $TX_BYTES_OLD))

        RX_KBPS=$(($RX_DIFF*8/1000/$INTERVAL))
        TX_KBPS=$(($TX_DIFF*8/1000/$INTERVAL))

        echo "IN: ${RX_KBPS} kbps | Out: ${TX_KBPS} kbps"
done

sudo chmod +x monitor_wap.sh
sudo ./monitor_wap.sh

# WIRELESS ACCESS POINT ENDS


# ADDITIONAL FEATURES STARTS

# install Netdata
sudo wget -O /tmp/netdata-kickstart.sh https://get.netdata.cloud/kickstart.sh && sh /tmp/netdata-kickstart.sh

# open the netdata web
http://localhost:19999

# firewall
sudo apt install ufw
# enable ufw (activate the firewall)
sudo ufw enable


# configure firewall rules
#SSH, HTTP, HTTPS, FTP, SMTP, DNS, IMAP, NetData port
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 20/tcp
sudo ufw allow 21/tcp
sudo ufw allow 25/tcp
sudo ufw allow 53/tcp
sudo ufw allow 53/udp
sudo ufw allow 143/tcp
sudo ufw allow 19999/tcp 
# to check ufw status (which rules are currently applied)
sudo ufw status verbose

# restart ufw service and auto-start on boot
sudo systemctl restart ufw
sudo systemctl enable ufw

# Snort ( not done )
sudo apt install snort

sudo nano /etc/snort/snort.conf
ipvar HOME_NET 192.168.25.0/24
# testing the configuration for syntax errors
sudo snort -T -c /etc/snort/snort.conf

sudo apt install snort-rules-default

sudo systemctl start snort
sudo systemctl enable snort

# start listening to network
sudo snort -A console -q -c /etc/snort/snort.conf -i wlp0s20f3

# ADDITIONAL FEATURES ENDS